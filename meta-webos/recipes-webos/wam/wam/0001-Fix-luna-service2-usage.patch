From e67bd0464a7c98250eba80dd032ca56015ee244e Mon Sep 17 00:00:00 2001
From: Martin Jansa <martin2.jansa@lgepartner.com>
Date: Tue, 21 Mar 2023 00:19:34 +0000
Subject: [PATCH] Fix luna-service2 usage

:Release Notes:
Since luna-service2 submission 143 from September 2012 ls2 headers
should be included from luna-service2 directory and linking should
respect LDFLAGS from pkg-config.

:Detailed Notes:
Fixes:
http://gecko.lge.com:8000/Errors/Details/556600

FAILED: src/platform/libWebAppMgr.so.1.0.0
: && TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot-native/usr/bin/clang++ -fPIC -m64 -march=core2 -mtune=core2 -msse3 -mfpmath=sse -fstack-protector-strong  -O2 -D_FORTIFY_SOURCE=2 -Wformat -Wformat-security -Werror=format-security -Werror=return-type     --sysroot=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot     --target=x86_64-webos-linux     -stdlib=libc++     -fuse-ld=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot-native/usr/bin/ld.lld     -nostdinc++     -isystem TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot/usr/include/c++/v1/     -Wl,-LTOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot//usr/lib/cbe     -Wl,-rpath,/usr/lib/cbe     -D_LIBCPP_HAS_NO_VENDOR_AVAILABILITY_ANNOTATIONS    -O2 -pipe -g -feliminate-unused-debug-types -fmacro-prefix-map=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3=/usr/src/debug/wam-clang/1.0.2-73-r3                      -fdebug-prefix-map=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3=/usr/src/debug/wam-clang/1.0.2-73-r3                      -fdebug-prefix-map=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot=                      -fdebug-prefix-map=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot-native=  -fvisibility-inlines-hidden  -ITOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot/usr/include/cbe     -Wno-error=unused-command-line-argument     -Wno-error=inconsistent-missing-override     -Wno-format  -fno-rtti -fno-exceptions -funwind-tables -std=c++14 -Wno-psabi -DNDEBUG  -Wl,-O1 -Wl,--hash-style=gnu -Wl,--as-needed -fmacro-prefix-map=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3=/usr/src/debug/wam-clang/1.0.2-73-r3                      -fdebug-prefix-map=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3=/usr/src/debug/wam-clang/1.0.2-73-r3                      -fdebug-prefix-map=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot=                      -fdebug-prefix-map=TOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot-native=  -Wl,-z,relro,-z,now   -Wl,--no-as-needed -Wno-psabi -rdynamic -shared -Wl,-soname,libWebAppMgr.so.1.0 -o src/platform/libWebAppMgr.so.1.0.0 src/platform/CMakeFiles/WebAppMgr.dir/palm_system_webos.cc.o src/platform/CMakeFiles/WebAppMgr.dir/web_app_wayland.cc.o src/platform/CMakeFiles/WebAppMgr.dir/web_app_wayland_window.cc.o src/platform/CMakeFiles/WebAppMgr.dir/web_app_window_impl.cc.o src/platform/CMakeFiles/WebAppMgr.dir/webengine/blink_web_process_manager.cc.o src/platform/CMakeFiles/WebAppMgr.dir/webengine/blink_web_view.cc.o src/platform/CMakeFiles/WebAppMgr.dir/webengine/blink_web_view_profile_helper.cc.o src/platform/CMakeFiles/WebAppMgr.dir/webengine/palm_system_blink.cc.o src/platform/CMakeFiles/WebAppMgr.dir/webengine/web_page_blink.cc.o src/platform/CMakeFiles/WebAppMgr.dir/webengine/web_view_impl.cc.o src/platform/CMakeFiles/WebAppMgr.dir/__/webos/device_info_impl.cc.o src/platform/CMakeFiles/WebAppMgr.dir/__/webos/palm_service_base.cc.o src/platform/CMakeFiles/WebAppMgr.dir/__/webos/platform_module_factory_impl.cc.o src/platform/CMakeFiles/WebAppMgr.dir/__/webos/plugin_service_luna.cc.o src/platform/CMakeFiles/WebAppMgr.dir/__/webos/service_sender_luna.cc.o src/platform/CMakeFiles/WebAppMgr.dir/__/webos/web_app_manager_service_luna.cc.o src/platform/CMakeFiles/WebAppMgr.dir/__/webos/web_app_manager_service_luna_impl.cc.o  -Wl,-rpath,"\$ORIGIN/../core:"  -LTOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot/usr/lib/cbe  -ljsoncpp  -LTOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot/usr/lib  -lluna-prefs  -ljson-c  src/core/libWebAppMgrCore.so.1.0.0  -llunaservice  -LTOPDIR/BUILD/work/qemux86_64-webos-linux/wam-clang/1.0.2-73-r3/recipe-sysroot/usr/lib  -lcbe  -lglib-2.0  -lPmLogLib  -ldl && :
clang-14: warning: argument unused during compilation: '-nostdinc++' [-Wunused-command-line-argument]
ld.lld: error: unable to find library -llunaservice

:Testing Performed:
Only build tested.

:QA Notes:
No change to image.

:Issues Addressed:
[WRP-10642] Remove the temporary work around from 2012 from luna-service2 recipe
[WRP-11676] wam: Fix luna-service2 usage
[WRP-10791] CCC: Various build fixes

Change-Id: I4cf739f46c5cf082a8789b0e463eb41617b17b6a
---
Upstream-Status: Submitted [http://gpro.lge.com/c/webosose/wam/+/348188 Fix luna-service2 usage]

 src/CMakeLists.txt          | 1 +
 src/platform/CMakeLists.txt | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 5d3d0313..d9dfe571 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -23,6 +23,7 @@ pkg_search_module(CHROMIUM REQUIRED libcbe)
 pkg_search_module(GLIB REQUIRED glib-2.0)
 pkg_search_module(JSONCPP REQUIRED jsoncpp)
 pkg_search_module(LIBLUNAPREFS REQUIRED luna-prefs)
+pkg_search_module(LS2 REQUIRED luna-service2)
 set(PKGCONFIG_REQUIRES_PRIVATE "libcbe" "glib-2.0" "jsoncpp" "luna-prefs")
 
 if(DISABLE_PMLOG)
diff --git a/src/platform/CMakeLists.txt b/src/platform/CMakeLists.txt
index 46582965..f95757fa 100644
--- a/src/platform/CMakeLists.txt
+++ b/src/platform/CMakeLists.txt
@@ -76,8 +76,8 @@ set(WAM_LIB_INCLUDE_DIRS
 set(WAM_LIB_LIBS
     ${JSONCPP_LDFLAGS}
     ${LIBLUNAPREFS_LDFLAGS}
+    ${LS2_LDFLAGS}
     WebAppMgrCore
-    lunaservice
 )
 
 add_library(${PROJECT_NAME} SHARED ${HEADERS} ${SOURCES})
